/**
 * Code generation utilities for exporting quest configurations.
 * Generates JSON and TypeScript code that matches @quest-payments/models.
 */

/**
 * Convert basis points to percentage for display.
 * @param {number} bps
 * @returns {string} e.g. "5.00%"
 */
function bpsToPercent(bps) {
  return (bps / 100).toFixed(2) + '%';
}

/**
 * Escape string for safe inclusion in TypeScript string literals.
 * @param {string} str
 * @returns {string}
 */
function escapeString(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
}

/**
 * Generate a valid JavaScript identifier from a string.
 * e.g. "My Event 2025" â†’ "myEvent2025"
 * @param {string} str
 * @returns {string}
 */
function toCamelCase(str) {
  return str
    .toLowerCase()
    .replace(/[^a-z0-9]+(.)/g, (_, char) => char.toUpperCase())
    .replace(/^[0-9]/, '_$&'); // Prefix with underscore if starts with digit
}

/**
 * Generate JSON export of a quest configuration.
 * @param {Record<string, any>} questState
 * @returns {string} JSON string (pretty-printed)
 */
export function generateJsonExport(questState) {
  const questJson = {
    version: '1.0',
    quest: {
      id: questState.questId,
      name: questState.questName,
      description: questState.description,
      expiresAt: questState.expiresAt,
      metadata: questState.metadata,
      incentives: questState.incentives.map(inc => ({
        id: inc.id,
        type: inc.type,
        discountBps: inc.discountBps,
        description: inc.description,
        expiresAt: inc.expiresAt,
      })),
    },
  };

  return JSON.stringify(questJson, null, 2);
}

/**
 * Generate TypeScript code export of a quest configuration.
 * Output can be directly imported into a Quest Payments backend.
 * @param {Record<string, any>} questState
 * @returns {string} TypeScript code
 */
export function generateTypescriptExport(questState) {
  const varName = toCamelCase(questState.questName || 'quest') + 'Incentives';
  const questDescription = escapeString(questState.description || '');
  const organizerName = escapeString(questState.metadata.organizerName || '');

  const incentiveCode = questState.incentives
    .map(inc => {
      const desc = escapeString(inc.description || '');
      return `  {
    id: incentiveId('${inc.id}'),
    type: '${inc.type}',
    discountBps: ${inc.discountBps},
    description: '${desc}',
    expiresAt: new Date('${inc.expiresAt}'),
  }`;
    })
    .join(',\n');

  return `import {
  eventId,
  incentiveId,
  TicketTier,
  QuestEvent,
} from '@quest-payments/models';

/**
 * Incentive definitions for ${questState.questName || 'Quest'}
 * Auto-generated by Quest Payments builder
 */
export const ${varName}: typeof import('@quest-payments/models').IncentiveDefinition[] = [
${incentiveCode}
];

/**
 * Example: How to use these incentives in a QuestEvent
 */
export const ${toCamelCase(questState.questName || 'quest')}Event: QuestEvent = {
  id: eventId('event-${questState.questId}'),
  name: '${escapeString(questState.questName || '')}',
  description: '${questDescription}',
  startsAt: new Date('${new Date().toISOString()}'),
  endsAt: new Date('${questState.expiresAt}'),
  organizer: '${organizerName}',
  ticketTiers: [
    {
      name: 'General Admission',
      price: { amount: BigInt(10000), currency: 'USD', decimals: 2 },
      maxQuantity: 500,
      maxDiscountPct: ${Math.min(100, questState.incentives.reduce((sum, inc) => sum + inc.discountBps, 0) / 100)},
    },
  ],
  incentives: ${varName},
};
`;
}

/**
 * Generate downloadable filename based on quest name.
 * @param {string} questName
 * @param {string} format 'json' or 'ts'
 * @returns {string}
 */
export function generateFilename(questName, format) {
  const safeName = (questName || 'quest')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
  const timestamp = new Date().toISOString().split('T')[0];
  const ext = format === 'json' ? 'json' : 'ts';
  return `${safeName}-${timestamp}.${ext}`;
}

/**
 * Copy text to clipboard (with fallback for older browsers).
 * @param {string} text
 * @returns {Promise<boolean>} True if successful
 */
export async function copyToClipboard(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    } else {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textarea);
      return success;
    }
  } catch (err) {
    console.error('Copy to clipboard failed:', err);
    return false;
  }
}

/**
 * Trigger a file download.
 * @param {string} filename
 * @param {string} content
 * @param {string} mimeType
 */
export function downloadFile(filename, content, mimeType = 'text/plain') {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/**
 * Highlight JSON syntax (simple version, no dependencies).
 * Wraps code in <span> elements with data-syntax-type for CSS styling.
 * @param {string} json
 * @returns {string} HTML string
 */
export function highlightJson(json) {
  return json
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][^}]*)?)/g,
      (match) => {
        let cls = 'number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'key';
          } else {
            cls = 'string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'boolean';
        } else if (/null/.test(match)) {
          cls = 'null';
        }
        return `<span class="syntax-${cls}">${match}</span>`;
      }
    );
}

/**
 * Highlight TypeScript syntax (simple version, no dependencies).
 * @param {string} code
 * @returns {string} HTML string
 */
export function highlightTypescript(code) {
  return code
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    // Keywords
    .replace(/\b(import|from|export|const|interface|type|new|as|typeof)\b/g,
      '<span class="syntax-keyword">$1</span>')
    // Strings
    .replace(/'([^']|\\')*'/g, (match) => `<span class="syntax-string">${match}</span>`)
    // Comments
    .replace(/\/\/.*$/gm, (match) => `<span class="syntax-comment">${match}</span>`)
    .replace(/\/\*[\s\S]*?\*\//g, (match) => `<span class="syntax-comment">${match}</span>`)
    // Numbers
    .replace(/\b\d+\b/g, (match) => `<span class="syntax-number">${match}</span>`)
    // Function names
    .replace(/\b([a-z_]\w*)\s*(?=\()/gi,
      (match) => `<span class="syntax-function">${match}</span>`);
}
